import { experimental_generateImage as generateImage } from 'ai';
import { openai } from '@ai-sdk/openai';
import { z } from 'zod';

export async function POST({ request }: { request: Request }) {
    try {
        const body = await request.json().catch(() => ({}));

        const schema = z.object({ prompt: z.string().min(1).optional() }).strict();
        const { prompt = 'Santa Claus driving a Cadillac' } = schema.parse(body);

        const result = await generateImage({
            model: openai.image('dall-e-3'),
            prompt,
            size: '1024x1024',
            providerOptions: {
                openai: { style: 'vivid', quality: 'hd' },
            },
        });

        const { image } = result as any;

        if (!image || !image.base64) {
            throw new Error('No image returned from provider');
        }

        return new Response(JSON.stringify({ imageBase64: image.base64 }), {
            headers: { 'Content-Type': 'application/json' },
        });
    } catch (err) {
        console.error('Image generation error:', err);
        const message = err instanceof Error ? err.message : String(err);
        return new Response(JSON.stringify({ error: message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' },
        });
    }
}